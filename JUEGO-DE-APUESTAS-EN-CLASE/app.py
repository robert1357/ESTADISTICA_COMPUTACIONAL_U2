import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import warnings
import os
warnings.filterwarnings('ignore')

# Importar m√≥dulos personalizados
from utils.data_loader import load_csv_with_encoding, get_basic_info
from utils.statistics import get_descriptive_stats, detect_outliers, clean_data
from utils.visualizations import create_visualizations
from utils.advanced_analytics import perform_advanced_analysis
from utils.report_generator import generate_report

# Configuraci√≥n de la p√°gina
st.set_page_config(
    page_title="Analizador de CSV - An√°lisis Estad√≠stico Completo",
    page_icon="üìä",
    layout="wide",
    initial_sidebar_state="expanded"
)

# T√≠tulo principal
st.title("üìä Analizador de CSV - An√°lisis Estad√≠stico Completo")
st.markdown("**Una herramienta completa para el an√°lisis estad√≠stico de datos CSV**")

# Sidebar para navegaci√≥n
st.sidebar.title("üß≠ Navegaci√≥n")
sections = [
    "üè† Inicio",
    "üìÇ Carga y Exploraci√≥n",
    "üìà Estad√≠sticas Descriptivas",
    "üßπ Detecci√≥n y Limpieza",
    "üìä Visualizaciones",
    "üî¨ An√°lisis Avanzado",
    "üìã Conclusiones y Reporte",
    "üìä An√°lisis Completo ENAHO",
    "üñºÔ∏è Gr√°ficos y Visualizaciones",
    "üìÑ Documentos ENAHO"
]

selected_section = st.sidebar.selectbox("Seleccionar secci√≥n:", sections)

# Inicializar session state
if 'data' not in st.session_state:
    st.session_state.data = None
if 'cleaned_data' not in st.session_state:
    st.session_state.cleaned_data = None
if 'analysis_results' not in st.session_state:
    st.session_state.analysis_results = {}

# Secci√≥n de Inicio
if selected_section == "üè† Inicio":
    st.header("Bienvenido al Analizador de CSV")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("üéØ Caracter√≠sticas principales:")
        st.markdown("""
        - **Carga autom√°tica** con detecci√≥n de codificaci√≥n
        - **Estad√≠sticas descriptivas** completas
        - **Detecci√≥n de valores at√≠picos** (IQR y Z-score)
        - **Visualizaciones interactivas** con Plotly
        - **An√°lisis estad√≠stico avanzado** (Regresi√≥n, PCA, Clustering)
        - **Reportes descargables** en espa√±ol
        """)
    
    with col2:
        st.subheader("üìã Estructura del an√°lisis:")
        st.markdown("""
        1. **Carga y Exploraci√≥n**: Informaci√≥n b√°sica del dataset
        2. **Estad√≠sticas Descriptivas**: Medidas de tendencia y dispersi√≥n
        3. **Limpieza de Datos**: Detecci√≥n y tratamiento de anomal√≠as
        4. **Visualizaciones**: Gr√°ficos interactivos y mapas de calor
        5. **An√°lisis Avanzado**: T√©cnicas de machine learning
        6. **Conclusiones**: Insights autom√°ticos y recomendaciones
        """)
    
    st.info("üëÜ Usa el men√∫ lateral para navegar entre las diferentes secciones del an√°lisis.")

# Secci√≥n 1: Carga y Exploraci√≥n
elif selected_section == "üìÇ Carga y Exploraci√≥n":
    st.header("1. Carga y Exploraci√≥n Inicial de Datos")
    
    uploaded_file = st.file_uploader(
        "Selecciona un archivo CSV para analizar:",
        type=['csv'],
        help="Sube tu archivo CSV. El sistema detectar√° autom√°ticamente la codificaci√≥n."
    )
    
    if uploaded_file is not None:
        try:
            # Cargar datos con detecci√≥n autom√°tica de codificaci√≥n
            with st.spinner('Cargando y procesando archivo...'):
                data = load_csv_with_encoding(uploaded_file)
                st.session_state.data = data
            
            st.success(f"‚úÖ Archivo cargado exitosamente: {uploaded_file.name}")
            
            # Mostrar informaci√≥n b√°sica
            basic_info = get_basic_info(data)
            
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                st.metric("Filas", basic_info['rows'])
            with col2:
                st.metric("Columnas", basic_info['columns'])
            with col3:
                st.metric("Valores nulos", basic_info['null_values'])
            with col4:
                st.metric("Duplicados", basic_info['duplicates'])
            
            # Informaci√≥n detallada de columnas
            st.subheader("üìã Informaci√≥n de Columnas")
            col_info = pd.DataFrame({
                'Columna': data.columns,
                'Tipo de Dato': data.dtypes,
                'Valores Nulos': data.isnull().sum(),
                'Valores √önicos': data.nunique(),
                'Porcentaje Nulos': (data.isnull().sum() / len(data) * 100).round(2)
            })
            st.dataframe(col_info, use_container_width=True)
            
            # Primeras y √∫ltimas filas
            col1, col2 = st.columns(2)
            with col1:
                st.subheader("üîù Primeras 5 filas")
                st.dataframe(data.head(), use_container_width=True)
            
            with col2:
                st.subheader("üîö √öltimas 5 filas")
                st.dataframe(data.tail(), use_container_width=True)
            
            # Mostrar tipos de variables
            numeric_cols = data.select_dtypes(include=[np.number]).columns.tolist()
            categorical_cols = data.select_dtypes(include=['object', 'category']).columns.tolist()
            
            col1, col2 = st.columns(2)
            with col1:
                st.subheader("üî¢ Variables Num√©ricas")
                if numeric_cols:
                    st.write(numeric_cols)
                else:
                    st.info("No se encontraron variables num√©ricas")
            
            with col2:
                st.subheader("üìù Variables Categ√≥ricas")
                if categorical_cols:
                    st.write(categorical_cols)
                else:
                    st.info("No se encontraron variables categ√≥ricas")
                    
        except Exception as e:
            st.error(f"‚ùå Error al cargar el archivo: {str(e)}")
            st.info("Verifica que el archivo sea un CSV v√°lido.")

# Secci√≥n 2: Estad√≠sticas Descriptivas
elif selected_section == "üìà Estad√≠sticas Descriptivas":
    st.header("2. Estad√≠sticas Descriptivas B√°sicas")
    
    if st.session_state.data is not None:
        data = st.session_state.data
        
        # Obtener estad√≠sticas descriptivas
        stats_results = get_descriptive_stats(data)
        
        # Variables num√©ricas
        if 'numeric_stats' in stats_results:
            st.subheader("üî¢ Estad√≠sticas para Variables Num√©ricas")
            st.dataframe(stats_results['numeric_stats'], use_container_width=True)
            
            # Medidas adicionales
            numeric_cols = data.select_dtypes(include=[np.number]).columns
            if len(numeric_cols) > 0:
                st.subheader("üìä Medidas Adicionales")
                additional_stats = pd.DataFrame({
                    'Varianza': data[numeric_cols].var(),
                    'Desviaci√≥n Est√°ndar': data[numeric_cols].std(),
                    'Rango': data[numeric_cols].max() - data[numeric_cols].min(),
                    'Coeficiente de Variaci√≥n': (data[numeric_cols].std() / data[numeric_cols].mean() * 100).round(2)
                })
                st.dataframe(additional_stats, use_container_width=True)
        
        # Variables categ√≥ricas
        if 'categorical_stats' in stats_results:
            st.subheader("üìù Estad√≠sticas para Variables Categ√≥ricas")
            categorical_cols = data.select_dtypes(include=['object', 'category']).columns
            
            for col in categorical_cols:
                with st.expander(f"An√°lisis de: {col}"):
                    value_counts = data[col].value_counts()
                    percentages = (data[col].value_counts(normalize=True) * 100).round(2)
                    
                    col1, col2 = st.columns(2)
                    with col1:
                        st.write("**Frecuencias:**")
                        st.dataframe(value_counts)
                    with col2:
                        st.write("**Porcentajes:**")
                        st.dataframe(percentages)
        
        # Matriz de correlaci√≥n para variables num√©ricas
        numeric_data = data.select_dtypes(include=[np.number])
        if len(numeric_data.columns) > 1:
            st.subheader("üîó Matriz de Correlaci√≥n")
            corr_matrix = numeric_data.corr()
            
            fig = px.imshow(
                corr_matrix,
                text_auto=True,
                aspect="auto",
                title="Matriz de Correlaci√≥n entre Variables Num√©ricas",
                color_continuous_scale='RdBu'
            )
            fig.update_layout(height=600)
            st.plotly_chart(fig, use_container_width=True)
            
            # Correlaciones m√°s fuertes
            st.subheader("üèÜ Correlaciones M√°s Significativas")
            corr_pairs = []
            for i in range(len(corr_matrix.columns)):
                for j in range(i+1, len(corr_matrix.columns)):
                    corr_pairs.append({
                        'Variable 1': corr_matrix.columns[i],
                        'Variable 2': corr_matrix.columns[j],
                        'Correlaci√≥n': corr_matrix.iloc[i, j]
                    })
            
            corr_df = pd.DataFrame(corr_pairs)
            corr_df = corr_df.sort_values('Correlaci√≥n', key=abs, ascending=False)
            st.dataframe(corr_df.head(10), use_container_width=True)
    
    else:
        st.warning("‚ö†Ô∏è Primero debes cargar un archivo CSV en la secci√≥n 'Carga y Exploraci√≥n'.")

# Secci√≥n 3: Detecci√≥n y Limpieza
elif selected_section == "üßπ Detecci√≥n y Limpieza":
    st.header("3. Detecci√≥n y Limpieza de Datos")
    
    if st.session_state.data is not None:
        data = st.session_state.data
        
        # Valores nulos
        st.subheader("üï≥Ô∏è An√°lisis de Valores Nulos")
        null_counts = data.isnull().sum()
        null_percentages = (data.isnull().sum() / len(data) * 100).round(2)
        
        null_df = pd.DataFrame({
            'Columna': null_counts.index,
            'Valores Nulos': null_counts.values,
            'Porcentaje': null_percentages.values
        })
        null_df = null_df[null_df['Valores Nulos'] > 0].sort_values('Valores Nulos', ascending=False)
        
        if len(null_df) > 0:
            st.dataframe(null_df, use_container_width=True)
            
            # Visualizaci√≥n de valores nulos
            fig = px.bar(
                null_df, 
                x='Columna', 
                y='Porcentaje',
                title="Porcentaje de Valores Nulos por Columna",
                color='Porcentaje',
                color_continuous_scale='Reds'
            )
            st.plotly_chart(fig, use_container_width=True)
        else:
            st.success("‚úÖ No se encontraron valores nulos en el dataset.")
        
        # Detecci√≥n de valores at√≠picos
        st.subheader("üéØ Detecci√≥n de Valores At√≠picos")
        numeric_cols = data.select_dtypes(include=[np.number]).columns.tolist()
        
        if numeric_cols:
            selected_col = st.selectbox("Selecciona una variable para analizar:", numeric_cols)
            
            if selected_col:
                outliers_info = detect_outliers(data, selected_col)
                
                col1, col2 = st.columns(2)
                with col1:
                    st.metric("Valores at√≠picos (IQR)", len(outliers_info['iqr_outliers']))
                with col2:
                    st.metric("Valores at√≠picos (Z-score)", len(outliers_info['zscore_outliers']))
                
                # Visualizaci√≥n de boxplot
                fig = px.box(
                    data, 
                    y=selected_col,
                    title=f"Boxplot para {selected_col} - Detecci√≥n de Valores At√≠picos"
                )
                st.plotly_chart(fig, use_container_width=True)
                
                # Mostrar valores at√≠picos
                if len(outliers_info['iqr_outliers']) > 0:
                    st.subheader("üìã Valores At√≠picos Detectados (M√©todo IQR)")
                    outlier_data = data.loc[outliers_info['iqr_outliers']]
                    st.dataframe(outlier_data[[selected_col]], use_container_width=True)
        
        # Opciones de limpieza
        st.subheader("üßΩ Opciones de Limpieza de Datos")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.subheader("Tratamiento de Valores Nulos")
            null_strategy = st.selectbox(
                "Estrategia para valores nulos:",
                ["No aplicar", "Eliminar filas", "Imputar con media", "Imputar con mediana", "Imputar con moda"]
            )
        
        with col2:
            st.subheader("Tratamiento de Valores At√≠picos")
            outlier_strategy = st.selectbox(
                "Estrategia para valores at√≠picos:",
                ["No aplicar", "Eliminar valores at√≠picos", "Transformar con log", "Winsorizaci√≥n"]
            )
        
        if st.button("üîÑ Aplicar Limpieza de Datos"):
            try:
                cleaned_data = clean_data(data, null_strategy, outlier_strategy)
                st.session_state.cleaned_data = cleaned_data
                
                st.success("‚úÖ Datos limpiados exitosamente!")
                
                # Mostrar comparaci√≥n antes/despu√©s
                col1, col2 = st.columns(2)
                with col1:
                    st.metric("Filas originales", len(data))
                    st.metric("Valores nulos originales", data.isnull().sum().sum())
                with col2:
                    st.metric("Filas despu√©s de limpieza", len(cleaned_data))
                    st.metric("Valores nulos despu√©s", cleaned_data.isnull().sum().sum())
                    
            except Exception as e:
                st.error(f"‚ùå Error durante la limpieza: {str(e)}")
    
    else:
        st.warning("‚ö†Ô∏è Primero debes cargar un archivo CSV en la secci√≥n 'Carga y Exploraci√≥n'.")

# Secci√≥n 4: Visualizaciones
elif selected_section == "üìä Visualizaciones":
    st.header("4. Visualizaciones Completas")
    
    if st.session_state.data is not None:
        # Usar datos limpios si est√°n disponibles, sino usar datos originales
        data = st.session_state.cleaned_data if st.session_state.cleaned_data is not None else st.session_state.data
        
        visualizations = create_visualizations(data)
        
        # Pesta√±as para organizar visualizaciones
        tabs = st.tabs([
            "üìä Distribuciones", 
            "üìà Correlaciones", 
            "üìã Categ√≥ricas", 
            "üîç Comparaciones",
            "üéØ Avanzadas"
        ])
        
        with tabs[0]:  # Distribuciones
            st.subheader("üìä Distribuciones de Variables Num√©ricas")
            if 'histograms' in visualizations:
                st.plotly_chart(visualizations['histograms'], use_container_width=True)
            
            st.subheader("üì¶ Boxplots para Detecci√≥n de Valores At√≠picos")
            if 'boxplots' in visualizations:
                st.plotly_chart(visualizations['boxplots'], use_container_width=True)
        
        with tabs[1]:  # Correlaciones
            st.subheader("üîó Mapa de Calor de Correlaciones")
            if 'correlation_heatmap' in visualizations:
                st.plotly_chart(visualizations['correlation_heatmap'], use_container_width=True)
            
            st.subheader("üéØ Gr√°ficos de Dispersi√≥n")
            if 'scatter_plots' in visualizations:
                st.plotly_chart(visualizations['scatter_plots'], use_container_width=True)
        
        with tabs[2]:  # Categ√≥ricas
            st.subheader("üìä Distribuci√≥n de Variables Categ√≥ricas")
            if 'categorical_plots' in visualizations:
                for plot in visualizations['categorical_plots']:
                    st.plotly_chart(plot, use_container_width=True)
        
        with tabs[3]:  # Comparaciones
            st.subheader("üéª Gr√°ficos de Viol√≠n")
            if 'violin_plots' in visualizations:
                st.plotly_chart(visualizations['violin_plots'], use_container_width=True)
            
            st.subheader("üìà Gr√°ficos de L√≠neas (si hay variables temporales)")
            if 'line_plots' in visualizations:
                st.plotly_chart(visualizations['line_plots'], use_container_width=True)
        
        with tabs[4]:  # Avanzadas
            st.subheader("üéØ Visualizaciones Avanzadas")
            if 'advanced_plots' in visualizations:
                for plot in visualizations['advanced_plots']:
                    st.plotly_chart(plot, use_container_width=True)
        
        # Descargar visualizaciones
        st.subheader("üíæ Exportar Visualizaciones")
        if st.button("üìÅ Generar ZIP con todas las visualizaciones"):
            st.info("Funcionalidad de descarga disponible - implementar seg√∫n necesidades espec√≠ficas")
    
    else:
        st.warning("‚ö†Ô∏è Primero debes cargar un archivo CSV en la secci√≥n 'Carga y Exploraci√≥n'.")

# Secci√≥n 5: An√°lisis Avanzado
elif selected_section == "üî¨ An√°lisis Avanzado":
    st.header("5. T√©cnicas Estad√≠sticas Avanzadas")
    
    if st.session_state.data is not None:
        data = st.session_state.cleaned_data if st.session_state.cleaned_data is not None else st.session_state.data
        
        # Selecci√≥n de t√©cnica de an√°lisis
        analysis_type = st.selectbox(
            "Selecciona la t√©cnica de an√°lisis:",
            [
                "An√°lisis de Correlaci√≥n Detallado",
                "Regresi√≥n Lineal/M√∫ltiple", 
                "Clustering (K-means)",
                "An√°lisis de Componentes Principales (PCA)",
                "Pruebas de Hip√≥tesis"
            ]
        )
        
        if st.button("üöÄ Ejecutar An√°lisis Avanzado"):
            with st.spinner(f'Ejecutando {analysis_type}...'):
                try:
                    results = perform_advanced_analysis(data, analysis_type)
                    st.session_state.analysis_results[analysis_type] = results
                    
                    # Mostrar resultados seg√∫n el tipo de an√°lisis
                    if analysis_type == "An√°lisis de Correlaci√≥n Detallado":
                        st.subheader("üîó An√°lisis de Correlaci√≥n Detallado")
                        if 'correlation_matrix' in results:
                            st.dataframe(results['correlation_matrix'], use_container_width=True)
                        if 'significant_correlations' in results:
                            st.subheader("üìä Correlaciones Significativas")
                            st.dataframe(results['significant_correlations'], use_container_width=True)
                    
                    elif analysis_type == "Regresi√≥n Lineal/M√∫ltiple":
                        st.subheader("üìà Resultados de Regresi√≥n")
                        col1, col2 = st.columns(2)
                        with col1:
                            st.metric("R¬≤ Score", f"{results.get('r2_score', 0):.4f}")
                        with col2:
                            st.metric("RMSE", f"{results.get('rmse', 0):.4f}")
                        
                        if 'feature_importance' in results:
                            st.subheader("üéØ Importancia de Variables")
                            st.dataframe(results['feature_importance'], use_container_width=True)
                        
                        if 'predictions_plot' in results:
                            st.plotly_chart(results['predictions_plot'], use_container_width=True)
                    
                    elif analysis_type == "Clustering (K-means)":
                        st.subheader("üéØ Resultados de Clustering")
                        col1, col2 = st.columns(2)
                        with col1:
                            st.metric("N√∫mero de Clusters", results.get('n_clusters', 0))
                        with col2:
                            st.metric("Silhouette Score", f"{results.get('silhouette_score', 0):.4f}")
                        
                        if 'cluster_plot' in results:
                            st.plotly_chart(results['cluster_plot'], use_container_width=True)
                        
                        if 'cluster_centers' in results:
                            st.subheader("üìç Centros de Clusters")
                            st.dataframe(results['cluster_centers'], use_container_width=True)
                    
                    elif analysis_type == "An√°lisis de Componentes Principales (PCA)":
                        st.subheader("üîç Resultados de PCA")
                        col1, col2 = st.columns(2)
                        with col1:
                            st.metric("Componentes", len(results.get('explained_variance', [])))
                        with col2:
                            st.metric("Varianza Explicada Total", f"{sum(results.get('explained_variance', [])):.2%}")
                        
                        if 'pca_plot' in results:
                            st.plotly_chart(results['pca_plot'], use_container_width=True)
                        
                        if 'components_df' in results:
                            st.subheader("üìä Componentes Principales")
                            st.dataframe(results['components_df'], use_container_width=True)
                    
                    elif analysis_type == "Pruebas de Hip√≥tesis":
                        st.subheader("üß™ Resultados de Pruebas de Hip√≥tesis")
                        if 'test_results' in results:
                            for test_name, test_result in results['test_results'].items():
                                with st.expander(f"üìã {test_name}"):
                                    col1, col2 = st.columns(2)
                                    with col1:
                                        st.metric("Estad√≠stico", f"{test_result.get('statistic', 0):.4f}")
                                    with col2:
                                        st.metric("p-valor", f"{test_result.get('p_value', 0):.4f}")
                                    
                                    conclusion = "Rechazar H‚ÇÄ" if test_result.get('p_value', 1) < 0.05 else "No rechazar H‚ÇÄ"
                                    st.write(f"**Conclusi√≥n:** {conclusion} (Œ± = 0.05)")
                
                except Exception as e:
                    st.error(f"‚ùå Error durante el an√°lisis: {str(e)}")
        
        # Mostrar an√°lisis previos
        if st.session_state.analysis_results:
            st.subheader("üìã An√°lisis Realizados Previamente")
            for analysis_name in st.session_state.analysis_results.keys():
                st.info(f"‚úÖ {analysis_name}")
    
    else:
        st.warning("‚ö†Ô∏è Primero debes cargar un archivo CSV en la secci√≥n 'Carga y Exploraci√≥n'.")

# Secci√≥n 6: Conclusiones y Reporte
elif selected_section == "üìã Conclusiones y Reporte":
    st.header("6. Storytelling y Conclusiones")
    
    if st.session_state.data is not None:
        data = st.session_state.cleaned_data if st.session_state.cleaned_data is not None else st.session_state.data
        
        # Generar reporte autom√°tico
        if st.button("üìÑ Generar Reporte Completo"):
            with st.spinner('Generando reporte autom√°tico...'):
                try:
                    report = generate_report(data, st.session_state.analysis_results)
                    
                    # Resumen Ejecutivo
                    st.subheader("üìã Resumen Ejecutivo")
                    st.markdown(report.get('executive_summary', 'No disponible'))
                    
                    # Hallazgos Principales
                    st.subheader("üîç Hallazgos Principales")
                    if 'key_findings' in report:
                        for finding in report['key_findings']:
                            st.markdown(f"‚Ä¢ {finding}")
                    
                    # Insights Autom√°ticos
                    st.subheader("üí° Insights Autom√°ticos")
                    if 'insights' in report:
                        for insight in report['insights']:
                            st.info(insight)
                    
                    # Recomendaciones
                    st.subheader("üéØ Recomendaciones")
                    if 'recommendations' in report:
                        for recommendation in report['recommendations']:
                            st.success(recommendation)
                    
                    # Limitaciones
                    st.subheader("‚ö†Ô∏è Limitaciones del An√°lisis")
                    if 'limitations' in report:
                        for limitation in report['limitations']:
                            st.warning(limitation)
                    
                    # Pr√≥ximos Pasos
                    st.subheader("üöÄ Pr√≥ximos Pasos Sugeridos")
                    if 'next_steps' in report:
                        for step in report['next_steps']:
                            st.markdown(f"üìå {step}")
                    
                    # Bot√≥n de descarga del reporte
                    st.subheader("üíæ Descargar Reporte")
                    report_text = f"""
# REPORTE DE AN√ÅLISIS DE DATOS
## Generado autom√°ticamente

### RESUMEN EJECUTIVO
{report.get('executive_summary', 'No disponible')}

### HALLAZGOS PRINCIPALES
{chr(10).join(f'‚Ä¢ {finding}' for finding in report.get('key_findings', []))}

### INSIGHTS AUTOM√ÅTICOS  
{chr(10).join(f'‚Ä¢ {insight}' for insight in report.get('insights', []))}

### RECOMENDACIONES
{chr(10).join(f'‚Ä¢ {rec}' for rec in report.get('recommendations', []))}

### LIMITACIONES
{chr(10).join(f'‚Ä¢ {lim}' for lim in report.get('limitations', []))}

### PR√ìXIMOS PASOS
{chr(10).join(f'‚Ä¢ {step}' for step in report.get('next_steps', []))}
                    """
                    
                    # M√∫ltiples opciones de descarga
                    col1, col2, col3 = st.columns(3)
                    
                    with col1:
                        st.download_button(
                            label="üìÅ Reporte (.txt)",
                            data=report_text,
                            file_name="reporte_analisis_datos.txt",
                            mime="text/plain"
                        )
                    
                    with col2:
                        # Verificar si existe el archivo LaTeX
                        if os.path.exists("informe_enaho_2022.tex"):
                            with open("informe_enaho_2022.tex", "r", encoding="utf-8") as f:
                                latex_content = f.read()
                            st.download_button(
                                label="üìä LaTeX (.tex)",
                                data=latex_content,
                                file_name="informe_enaho_2022.tex",
                                mime="text/plain"
                            )
                    
                    with col3:
                        # Verificar si existe el archivo HTML
                        if os.path.exists("informe_enaho_2022.html"):
                            with open("informe_enaho_2022.html", "r", encoding="utf-8") as f:
                                html_content = f.read()
                            st.download_button(
                                label="üåê HTML (.html)",
                                data=html_content,
                                file_name="informe_enaho_2022.html",
                                mime="text/html"
                            )
                    
                except Exception as e:
                    st.error(f"‚ùå Error al generar el reporte: {str(e)}")
        
        # M√©tricas del dataset
        st.subheader("üìä M√©tricas Finales del Dataset")
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("Filas Totales", len(data))
        with col2:
            st.metric("Columnas Totales", len(data.columns))
        with col3:
            st.metric("Completitud", f"{((1 - data.isnull().sum().sum() / (len(data) * len(data.columns))) * 100):.1f}%")
        with col4:
            st.metric("An√°lisis Realizados", len(st.session_state.analysis_results))
    
    else:
        st.warning("‚ö†Ô∏è Primero debes cargar un archivo CSV en la secci√≥n 'Carga y Exploraci√≥n'.")

# Nueva Secci√≥n: An√°lisis Completo ENAHO
elif selected_section == "üìä An√°lisis Completo ENAHO":
    st.header("üìä An√°lisis Estad√≠stico Completo - ENAHO 2022")
    st.markdown("**An√°lisis exhaustivo con las 4 secciones principales**")
    
    # Informaci√≥n del an√°lisis
    st.info("""
    üìã **An√°lisis implementado:**
    
    **1. Estad√≠sticas Descriptivas B√°sicas**
    - Resumen estad√≠stico completo (describe())
    - Medidas de tendencia central y dispersi√≥n
    - Percentiles detallados
    - An√°lisis de variables categ√≥ricas
    
    **2. Detecci√≥n y Limpieza de Datos**
    - Identificaci√≥n de valores nulos
    - Detecci√≥n de outliers (IQR y Z-score)
    - Estrategias de limpieza propuestas
    
    **3. Visualizaciones Completas**
    - Histogramas y boxplots
    - Matriz de correlaci√≥n
    - Scatter plots y violin plots
    - Gr√°ficos categ√≥ricas
    
    **4. T√©cnicas Estad√≠sticas Avanzadas**
    - Clustering K-means
    - An√°lisis PCA
    - Regresi√≥n m√∫ltiple
    - Pruebas de hip√≥tesis
    """)
    
    # Bot√≥n para ejecutar an√°lisis
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        if st.button("üöÄ Ejecutar An√°lisis Completo", use_container_width=True, type="primary"):
            with st.spinner("Ejecutando an√°lisis completo... Esto puede tomar unos minutos."):
                try:
                    # Ejecutar el an√°lisis completo
                    import subprocess
                    result = subprocess.run(['python', 'analisis_completo_enaho.py'], 
                                          capture_output=True, text=True, timeout=300)
                    
                    if result.returncode == 0:
                        st.success("‚úÖ An√°lisis completado exitosamente!")
                        
                        # Mostrar estad√≠sticas del an√°lisis
                        st.markdown("### üìà Resultados del An√°lisis")
                        
                        col1, col2, col3, col4 = st.columns(4)
                        with col1:
                            st.metric("Dataset", "ENAHO 2022")
                        with col2:
                            st.metric("Registros", "100")
                        with col3:
                            st.metric("Variables", "324")
                        with col4:
                            st.metric("T√©cnicas Aplicadas", "4")
                        
                        # Mostrar parte de la salida
                        st.markdown("### üìã Resumen de Resultados")
                        with st.expander("Ver detalles del an√°lisis"):
                            st.text(result.stdout[:2000] + "..." if len(result.stdout) > 2000 else result.stdout)
                        
                        # Verificar archivos generados
                        import os
                        archivos_generados = [
                            "analisis_completo_visualizaciones.png",
                            "matriz_correlacion.png",
                            "graficos_categoricas.png",
                            "scatter_plots.png",
                            "violin_plots.png",
                            "clustering_kmeans.png",
                            "pca_analysis.png",
                            "regression_analysis.png"
                        ]
                        
                        archivos_existentes = [f for f in archivos_generados if os.path.exists(f)]
                        
                        if archivos_existentes:
                            st.markdown("### üìÅ Visualizaciones Generadas")
                            st.success(f"‚úÖ Se generaron {len(archivos_existentes)} gr√°ficos exitosamente")
                            
                            # Mostrar lista de archivos
                            for archivo in archivos_existentes:
                                st.markdown(f"‚Ä¢ {archivo}")
                            
                            st.info("üí° Los gr√°ficos est√°n disponibles en el directorio del proyecto")
                    
                    else:
                        st.error("‚ùå Error durante la ejecuci√≥n del an√°lisis")
                        if result.stderr:
                            st.text("Error details:")
                            st.text(result.stderr)
                
                except subprocess.TimeoutExpired:
                    st.warning("‚è±Ô∏è El an√°lisis est√° tomando m√°s tiempo del esperado. Contin√∫a ejecut√°ndose en segundo plano.")
                except Exception as e:
                    st.error(f"‚ùå Error: {str(e)}")
    
    # Informaci√≥n adicional
    st.markdown("---")
    st.markdown("### üîç Detalles T√©cnicos")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        **üéØ Variables Analizadas:**
        - 118 variables num√©ricas
        - 206 variables categ√≥ricas
        - An√°lisis de completitud: 100%
        """)
    
    with col2:
        st.markdown("""
        **üìä T√©cnicas Aplicadas:**
        - K-means clustering
        - An√°lisis PCA
        - Regresi√≥n m√∫ltiple
        - Pruebas t-test
        """)

# Nueva Secci√≥n: Gr√°ficos y Visualizaciones
elif selected_section == "üñºÔ∏è Gr√°ficos y Visualizaciones":
    from visor_graficos import mostrar_graficos_disponibles, mostrar_resumen_graficos
    mostrar_graficos_disponibles()
    mostrar_resumen_graficos()

# Nueva Secci√≥n: Documentos ENAHO
elif selected_section == "üìÑ Documentos ENAHO":
    from documentos_enaho import show_download_section, create_pdf_instructions
    show_download_section()
    create_pdf_instructions()

# Footer
st.markdown("---")
st.markdown("**Analizador de CSV** - Herramienta completa para an√°lisis estad√≠stico de datos | Desarrollado con ‚ù§Ô∏è usando Streamlit")
